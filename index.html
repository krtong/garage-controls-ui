<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><title>Garage Controller</title><link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='8' y='16' width='48' height='40' rx='4' fill='%2318181b' stroke='%2310b981' stroke-width='3'/%3E%3Cpath d='M12 24h40M12 32h40M12 40h40M12 48h40' stroke='%233f3f46' stroke-width='2'/%3E%3Cpath d='M28 8h8v8h-8z' fill='%2310b981'/%3E%3C/svg%3E"><link rel="stylesheet" href="styles/tailwind.css"><style>body{margin:0;background:#09090b;color:#e4e4e7}.boot-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;background:#09090b;color:#e4e4e7;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",sans-serif;letter-spacing:.2em;text-transform:uppercase;z-index:50;transition:opacity .2s ease}body[data-ready="1"] .boot-screen{opacity:0;pointer-events:none}body:not([data-ready="1"]) #appContainer,body:not([data-ready="1"]) #loginPage{visibility:hidden}@keyframes pulse-glow{0%,100%{opacity:1}50%{opacity:.7}}.animate-pulse-glow{animation:pulse-glow 1.5s ease-in-out infinite}input[type=range]{-webkit-appearance:none;background:0 0}input[type=range]::-webkit-slider-runnable-track{height:8px;border-radius:9999px;background:#27272a}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;margin-top:-5px;cursor:pointer}input[type=range].accent-blue::-webkit-slider-thumb{background:#3b82f6}input[type=range].accent-red::-webkit-slider-thumb{background:#ef4444}input[type=range].accent-amber::-webkit-slider-thumb{background:#f59e0b}input[type=range].accent-zinc::-webkit-slider-thumb{background:#a1a1aa}.events-column,.timer-history-column{scrollbar-width:none;-ms-overflow-style:none}.events-column::-webkit-scrollbar,.timer-history-column::-webkit-scrollbar{width:0;height:0}.system-paused .door-schedule{background:rgba(251,191,36,0.15);color:#fbbf24;border:1px solid rgba(251,191,36,0.35)}.system-paused .door-schedule::before{content:"Paused - ";}</style></head><body class="min-h-screen bg-black text-zinc-100 overflow-x-hidden"><div class="boot-screen" id="bootScreen"><div style="font-size:16px;letter-spacing:.35em">Garage</div><div style="font-size:11px;letter-spacing:.4em;color:#a1a1aa">Controller</div><div style="font-size:10px;letter-spacing:.25em;color:#52525b">Loading…</div></div><div class="pointer-events-none fixed inset-0 z-0 bg-gradient-to-b from-black via-black to-emerald-950"></div><div class="pointer-events-none fixed inset-0 z-0"><div class="absolute bottom-[-260px] left-1/2 h-[720px] w-[720px] -translate-x-1/2 rounded-full bg-emerald-500/20 blur-[170px]"></div><div class="absolute bottom-[-240px] right-[-220px] h-[640px] w-[640px] rounded-full bg-emerald-400/10 blur-[160px]"></div><div class="absolute top-[-260px] left-[-240px] h-[620px] w-[620px] rounded-full bg-blue-500/10 blur-[170px]"></div></div><div class="pointer-events-none fixed inset-0 z-0 bg-gradient-to-t from-black/70 via-transparent to-black/25"></div><div id="loginPage" class="relative z-10 min-h-screen flex items-center justify-center px-3 sm:px-4"><div class="w-full max-w-md"><div class="text-center mb-6 sm:mb-8"><div class="text-2xl sm:text-3xl uppercase tracking-[0.3em] sm:tracking-[0.4em] text-zinc-100 mb-2">Garage</div><div class="text-xs sm:text-sm text-zinc-500 tracking-widest">Controller</div></div><div class="rounded-2xl sm:rounded-3xl border border-zinc-800/70 bg-zinc-900/50 backdrop-blur-sm p-5 sm:p-8"><form id="loginForm" autocomplete="on"><input id="loginUsername" name="username" autocomplete="username" aria-hidden="true" tabindex="-1" style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;opacity:0"><div class="mb-6"><div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Email</div><input type="email" id="loginEmail" autocomplete="username" class="w-full px-4 py-3 rounded-xl border border-zinc-700/50 bg-zinc-800/50 text-zinc-100 placeholder-zinc-500 focus:outline-none focus:border-emerald-500/50 transition-colors" placeholder="you@example.com"></div><div class="mb-6"><div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Password</div><input type="password" id="loginPassword" autocomplete="current-password" class="w-full px-4 py-3 rounded-xl border border-zinc-700/50 bg-zinc-800/50 text-zinc-100 placeholder-zinc-500 focus:outline-none focus:border-emerald-500/50 transition-colors" placeholder="••••••••"></div><div id="loginError" class="hidden mb-4 p-3 rounded-xl bg-red-500/10 border border-red-500/30 text-red-300 text-sm"></div><div id="resetNotice" class="hidden mb-4 p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/30 text-emerald-200 text-sm"></div><button id="loginBtn" type="submit" class="w-full py-3 rounded-xl bg-emerald-500/20 border border-emerald-500/30 text-emerald-300 text-xs uppercase tracking-widest font-medium hover:bg-emerald-500/30 transition-colors">Sign In</button> <button id="forgotBtn" type="button" class="mt-3 w-full text-[10px] uppercase tracking-widest text-zinc-400 transition hover:text-zinc-200">Forgot password</button></form><form id="resetRequestForm" class="hidden" autocomplete="on"><input id="resetUsername" name="username" autocomplete="username" aria-hidden="true" tabindex="-1" style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;opacity:0"><div class="mb-6"><div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Email</div><input type="email" id="resetEmail" autocomplete="username" class="w-full px-4 py-3 rounded-xl border border-zinc-700/50 bg-zinc-800/50 text-zinc-100 placeholder-zinc-500 focus:outline-none focus:border-emerald-500/50 transition-colors" placeholder="you@example.com"></div><div id="resetRequestError" class="hidden mb-4 p-3 rounded-xl bg-red-500/10 border border-red-500/30 text-red-300 text-sm"></div><button id="resetRequestBtn" type="submit" class="w-full py-3 rounded-xl bg-emerald-500/20 border border-emerald-500/30 text-emerald-300 text-xs uppercase tracking-widest font-medium hover:bg-emerald-500/30 transition-colors">Send reset link</button> <button id="resetBackBtn" type="button" class="mt-3 w-full text-[10px] uppercase tracking-widest text-zinc-400 transition hover:text-zinc-200">Back to sign in</button></form><form id="passwordResetForm" class="hidden" autocomplete="on"><input id="passwordResetUsername" name="username" autocomplete="username" aria-hidden="true" tabindex="-1" style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;opacity:0"><div class="mb-6"><div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">New password</div><input type="password" id="newPassword" autocomplete="new-password" class="w-full px-4 py-3 rounded-xl border border-zinc-700/50 bg-zinc-800/50 text-zinc-100 placeholder-zinc-500 focus:outline-none focus:border-emerald-500/50 transition-colors" placeholder="New password"></div><div class="mb-6"><div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Confirm password</div><input type="password" id="confirmPassword" autocomplete="new-password" class="w-full px-4 py-3 rounded-xl border border-zinc-700/50 bg-zinc-800/50 text-zinc-100 placeholder-zinc-500 focus:outline-none focus:border-emerald-500/50 transition-colors" placeholder="Confirm password"></div><div id="passwordResetError" class="hidden mb-4 p-3 rounded-xl bg-red-500/10 border border-red-500/30 text-red-300 text-sm"></div><button id="passwordResetBtn" type="submit" class="w-full py-3 rounded-xl bg-emerald-500/20 border border-emerald-500/30 text-emerald-300 text-xs uppercase tracking-widest font-medium hover:bg-emerald-500/30 transition-colors">Update password</button></form></div><div class="mt-6 text-center text-xs text-zinc-600">Secure authentication via Supabase</div></div></div><div id="appContainer" class="hidden"><header class="relative z-10 border-b border-zinc-800/50 px-3 sm:px-8 py-3 sm:py-6"><div class="mx-auto flex max-w-6xl flex-row items-center justify-between gap-2 sm:gap-4"><div class="min-w-0 text-base sm:text-2xl uppercase tracking-[0.15em] sm:tracking-[0.3em] truncate">Garage</div><div class="flex items-center justify-end gap-2 sm:gap-4"><button id="systemToggle" class="flex items-center gap-2 sm:gap-3 rounded-full border border-zinc-800 bg-zinc-900/50 px-2 sm:px-4 py-1 sm:py-2"><span class="hidden sm:inline text-xs uppercase tracking-wider text-zinc-400">System</span><div id="systemToggleTrack" class="relative h-5 sm:h-6 w-9 sm:w-12 rounded-full transition-colors bg-emerald-500/30"><div id="systemToggleThumb" class="absolute top-0.5 sm:top-1 h-4 w-4 rounded-full transition-all left-4 sm:left-7 bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.6)]"></div></div></button> <button id="settingsBtn" class="rounded-lg sm:rounded-xl border border-zinc-800 bg-zinc-900/50 p-1.5 sm:p-3 transition-colors hover:border-zinc-700"><svg class="w-4 h-4 sm:w-5 sm:h-5 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button></div></div></header><div id="systemStatusBanner" class="hidden relative z-20 border-b border-amber-500/30 bg-amber-500/10 text-amber-200 px-3 sm:px-8 py-2 sm:py-3 text-[10px] sm:text-xs uppercase tracking-widest">System paused - timers will not auto-close</div><div id="settingsPanel" class="relative z-20 hidden border-b border-zinc-800/50 bg-zinc-900/25 backdrop-blur-sm"><div class="mx-auto max-w-6xl px-4 sm:px-8 py-4 sm:py-6"><div class="flex flex-col gap-4"><div class="flex flex-wrap items-center justify-between gap-3"><div id="settingsDoorLabel" class="text-[10px] uppercase tracking-widest text-zinc-500">Door settings: Left</div><div class="flex rounded-xl bg-zinc-900/50 p-1 border border-zinc-800/50"><button class="settings-door-tab flex-1 rounded-lg px-3 py-2 text-[10px] uppercase tracking-widest transition-colors bg-zinc-800/70 text-zinc-100" data-door="Left">Left</button> <button class="settings-door-tab flex-1 rounded-lg px-3 py-2 text-[10px] uppercase tracking-widest transition-colors text-zinc-500" data-door="Middle">Middle</button> <button class="settings-door-tab flex-1 rounded-lg px-3 py-2 text-[10px] uppercase tracking-widest transition-colors text-zinc-500" data-door="Right">Right</button></div></div><div class="flex flex-col gap-6 md:flex-row md:items-end md:gap-8"><div class="flex-1"><div class="mb-3 text-[10px] uppercase tracking-widest text-zinc-500">Close Delay</div><div class="flex items-center gap-3"><div class="relative h-2 flex-1 overflow-hidden rounded-full bg-zinc-800"><div id="closeDelayBar" class="absolute inset-y-0 left-0 rounded-full bg-blue-500" style="width:28%"></div></div><span id="closeDelayValue" class="w-10 text-right font-mono text-xl font-light text-zinc-100">10</span> <span class="text-xs text-zinc-500">min</span></div><input type="range" id="closeDelaySlider" min="0" max="18" step="1" value="5" class="mt-2 w-full accent-blue"></div><div id="checkDelayRow" class="flex-1"><div class="mb-3 text-[10px] uppercase tracking-widest text-zinc-500">Check Delay</div><div class="flex items-center gap-3"><div class="relative h-2 flex-1 overflow-hidden rounded-full bg-zinc-800"><div id="checkDelayBar" class="absolute inset-y-0 left-0 rounded-full bg-red-500" style="width:14%"></div></div><span id="checkDelayValue" class="w-20 text-right font-mono text-xl font-light text-zinc-100">1m</span> <span class="text-xs text-zinc-500"></span></div><input type="range" id="checkDelaySlider" min="0.5" max="4" step="0.5" value="1" class="mt-2 w-full accent-red"></div><div class="flex-1"><div class="mb-3 text-[10px] uppercase tracking-widest text-zinc-500">Retry Delay</div><div class="flex items-center gap-3"><div class="relative h-2 flex-1 overflow-hidden rounded-full bg-zinc-800"><div id="retryDelayBar" class="absolute inset-y-0 left-0 rounded-full bg-amber-500" style="width:28%"></div></div><span id="retryDelayValue" class="w-10 text-right font-mono text-xl font-light text-zinc-100">5</span> <span class="text-xs text-zinc-500">min</span></div><input type="range" id="retryDelaySlider" min="3" max="10" step="1" value="5" class="mt-2 w-full accent-amber"></div><div id="disableAfterRow" class="flex-1"><div class="mb-3 text-[10px] uppercase tracking-widest text-zinc-500">Offline After Retries</div><div class="flex items-center gap-3"><div class="relative h-2 flex-1 overflow-hidden rounded-full bg-zinc-800"><div id="disableAfterBar" class="absolute inset-y-0 left-0 rounded-full bg-zinc-500" style="width:50%"></div></div><span id="disableAfterValue" class="w-10 text-right font-mono text-xl font-light text-zinc-100">10</span> <span class="text-xs text-zinc-500">tries</span></div><input type="range" id="disableAfterSlider" min="5" max="18" step="1" value="10" class="mt-2 w-full accent-zinc"></div><button id="saveSettingsBtn" class="w-full rounded-xl bg-zinc-100 px-6 py-3 text-xs font-medium uppercase tracking-widest text-zinc-900 transition-colors hover:bg-white md:w-auto">Save</button></div></div></div></div><div class="relative z-10 border-b border-zinc-800/30 px-3 sm:px-8 py-2 sm:py-4"><div class="mx-auto flex max-w-6xl flex-wrap items-center gap-1 sm:flex-nowrap sm:gap-6"><button id="tabState" class="flex items-center gap-1.5 sm:gap-2 rounded-lg p-2 sm:px-4 sm:py-2 transition-colors bg-zinc-800/50 text-zinc-100"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg> <span class="hidden sm:inline text-xs uppercase tracking-wider">State</span></button> <button id="tabEvents" class="flex items-center gap-1.5 sm:gap-2 rounded-lg p-2 sm:px-4 sm:py-2 transition-colors text-zinc-500 hover:text-zinc-300"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> <span class="hidden sm:inline text-xs uppercase tracking-wider">Events</span></button> <button id="tabAdmin" class="hidden flex items-center gap-1.5 sm:gap-2 rounded-lg p-2 sm:px-4 sm:py-2 transition-colors text-zinc-500 hover:text-zinc-300"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3l7 4v5c0 5-3 9-7 9s-7-4-7-9V7l7-4z"/></svg> <span class="hidden sm:inline text-xs uppercase tracking-wider">Admin</span></button> <button id="refreshBtn" class="ml-auto flex items-center gap-1.5 sm:gap-2 rounded-lg p-2 sm:px-4 sm:py-2 text-zinc-500 hover:text-zinc-300"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> <span class="hidden sm:inline text-xs uppercase tracking-wider">Refresh</span></button></div></div><main class="relative z-10 px-3 sm:px-8 py-4 sm:py-8 pb-24 sm:pb-28"><div class="mx-auto max-w-6xl"><div id="stateView" class="grid grid-cols-1 gap-4 sm:gap-6 md:grid-cols-3"></div><div id="eventsView" class="hidden"><div class="flex md:hidden mb-3 rounded-xl bg-zinc-900/50 p-1 border border-zinc-800/50"><button class="events-tab flex-1 rounded-lg py-2 text-[10px] uppercase tracking-widest transition-colors bg-zinc-800/70 text-zinc-100" data-door="Left">Left</button> <button class="events-tab flex-1 rounded-lg py-2 text-[10px] uppercase tracking-widest transition-colors text-zinc-500" data-door="Middle">Middle</button> <button class="events-tab flex-1 rounded-lg py-2 text-[10px] uppercase tracking-widest transition-colors text-zinc-500" data-door="Right">Right</button></div><div class="md:hidden"><div class="events-panel rounded-2xl border border-zinc-800/70 bg-zinc-900/25 p-3" data-door="Left"><div class="events-column max-h-[400px] overflow-auto rounded-xl border border-zinc-800/60 bg-zinc-950/25" data-door="Left"></div></div><div class="events-panel hidden rounded-2xl border border-zinc-800/70 bg-zinc-900/25 p-3" data-door="Middle"><div class="events-column max-h-[400px] overflow-auto rounded-xl border border-zinc-800/60 bg-zinc-950/25" data-door="Middle"></div></div><div class="events-panel hidden rounded-2xl border border-zinc-800/70 bg-zinc-900/25 p-3" data-door="Right"><div class="events-column max-h-[400px] overflow-auto rounded-xl border border-zinc-800/60 bg-zinc-950/25" data-door="Right"></div></div></div><div class="hidden md:grid grid-cols-3 gap-4"><div class="rounded-3xl border border-zinc-800/70 bg-zinc-900/25 p-4"><div class="mb-3 text-center text-xs uppercase tracking-widest text-zinc-500">Left</div><div class="events-column max-h-[480px] overflow-auto rounded-2xl border border-zinc-800/60 bg-zinc-950/25" data-door="Left"></div></div><div class="rounded-3xl border border-zinc-800/70 bg-zinc-900/25 p-4"><div class="mb-3 text-center text-xs uppercase tracking-widest text-zinc-500">Middle</div><div class="events-column max-h-[480px] overflow-auto rounded-2xl border border-zinc-800/60 bg-zinc-950/25" data-door="Middle"></div></div><div class="rounded-3xl border border-zinc-800/70 bg-zinc-900/25 p-4"><div class="mb-3 text-center text-xs uppercase tracking-widest text-zinc-500">Right</div><div class="events-column max-h-[480px] overflow-auto rounded-2xl border border-zinc-800/60 bg-zinc-950/25" data-door="Right"></div></div></div></div><div id="adminView" class="hidden"><div class="rounded-3xl border border-zinc-800/70 bg-zinc-900/25 p-4"><div class="mb-3 text-xs uppercase tracking-widest text-zinc-500">Timer History</div><div id="timerHistoryColumn" class="timer-history-column max-h-[420px] overflow-auto rounded-2xl border border-zinc-800/60 bg-zinc-950/25"></div></div></div></div></main><footer class="fixed bottom-0 left-0 right-0 z-10 border-t border-zinc-800/30 bg-zinc-950/80 px-4 sm:px-8 py-3 sm:py-4 backdrop-blur-sm"><div class="mx-auto flex max-w-6xl flex-wrap items-center gap-2 sm:justify-between"><button id="signOutBtn" class="text-[10px] sm:text-xs uppercase tracking-wider text-zinc-500 transition-colors hover:text-zinc-300">Sign out</button><div id="statusText" class="min-w-0 flex-1 text-right font-mono text-[9px] sm:text-[10px] text-zinc-600 truncate">Live data</div></div></footer></div><template id="doorCardTemplate"><div class="door-card relative rounded-2xl sm:rounded-3xl border border-zinc-800/70 bg-zinc-900/35 p-4 sm:p-6 transition-all duration-300 hover:bg-zinc-800/35"><div class="mb-4 sm:mb-6 flex items-start justify-between"><div class="min-w-0"><h3 class="door-name truncate text-xl sm:text-2xl font-extralight tracking-wide text-zinc-100"></h3><div class="door-schedule mt-1 inline-flex max-w-full items-center justify-center gap-2 rounded-full px-2 py-0.5 text-center text-[9px] sm:text-[10px] uppercase tracking-widest text-zinc-500 bg-zinc-700/35 break-words leading-tight">No Schedule</div></div></div><div class="mb-4 sm:mb-6 flex items-center gap-3 sm:gap-6"><div class="ring-container relative h-24 w-24 sm:h-36 sm:w-36 flex-shrink-0"><svg class="h-full w-full -rotate-90" viewBox="0 0 128 128"><circle cx="64" cy="64" r="58" fill="none" stroke="rgba(63, 63, 70, 0.28)" stroke-width="10"/><circle class="ring-progress" cx="64" cy="64" r="58" fill="none" stroke="#10b981" stroke-width="10" stroke-linecap="round" stroke-dasharray="364.42" stroke-dashoffset="0"/></svg><div class="ring-center absolute inset-0 flex flex-col items-center justify-center text-center"></div></div><div class="flex-1 min-w-0 space-y-2 sm:space-y-4"><div><div class="mb-0.5 sm:mb-1 text-[9px] sm:text-[10px] uppercase tracking-widest text-zinc-500">Latest Event</div><div class="flex items-center gap-1.5 sm:gap-2"><div class="event-dot h-1.5 w-1.5 sm:h-2 sm:w-2 rounded-full bg-emerald-400"></div><span class="event-type text-xs sm:text-sm text-zinc-300">—</span></div><div class="event-time mt-0.5 text-[10px] sm:text-xs text-zinc-500 truncate">—</div></div><div><div class="duration-label mb-0.5 sm:mb-1 text-[9px] sm:text-[10px] uppercase tracking-widest text-zinc-500">Closed For</div><div class="duration-value text-xs sm:text-sm text-zinc-300">—</div></div><div class="hidden"></div></div></div><div class="mb-3 sm:mb-4 rounded-lg sm:rounded-xl bg-zinc-950/35 p-2 sm:p-3"><div class="flex items-center justify-between"><div><div class="text-[9px] sm:text-[10px] uppercase tracking-widest text-zinc-500">Next Action</div><div class="next-action text-xs sm:text-sm text-zinc-400">—</div></div><div class="text-right"><div class="text-[9px] sm:text-[10px] uppercase tracking-widest text-zinc-500">Next In</div><div class="next-in text-xs sm:text-sm text-zinc-400">—</div></div></div><div class="attempts mt-2 text-[9px] sm:text-[10px] uppercase tracking-widest text-zinc-500">—</div></div><div class="action-container"></div></div></template><script>!function(){const e=()=>{document.body&&(document.body.dataset.ready="1")};if(window.tailwind)return void e();const n=document.getElementById("tailwindCdn");n&&(n.addEventListener("load",e,{once:!0}),n.addEventListener("error",e,{once:!0})),setTimeout(e,1500)}();</script><script type="module">import{createClient as e}from"https://esm.sh/@supabase/supabase-js@2";const t="https://gtxrrrlopzzskyaumgly.supabase.co",n="sb_publishable_J2IkXRAJM_ENwBmhjHKzIw_9mYRoLHZ",a=e(t,n),r="garage_anon_id";let o=!1;const s=6e4,i=2*Math.PI*58,l=1e3,c=[5,6,7,8,9,10,11,12,13,14,15,20,25,30,35,40,45,50,60],d=["Left","Middle","Right"],u=10,m="guest",g="readonly";let y=!0,f={closeDelay:10,checkDelay:1,retryDelay:5},p={Left:{closeDelay:10,checkDelay:1,retryDelay:5,disableAfter:u},Middle:{closeDelay:10,checkDelay:1,retryDelay:5,disableAfter:u},Right:{closeDelay:10,checkDelay:1,retryDelay:5,disableAfter:u}},h="Left",x=[],b=[],v=!1,w="state",_=!1,E=!1,D=!1,L=!1,S=!1,k=!1,C="",I=null,B=null,$=null,N=null,O=null,A=[],T=!1;const z=document.getElementById("stateView"),M=document.getElementById("eventsView"),F=document.getElementById("settingsPanel"),P=document.getElementById("doorCardTemplate"),q=document.getElementById("settingsBtn"),R=document.getElementById("systemToggle"),U=document.getElementById("adminView"),H=document.getElementById("timerHistoryColumn"),j=document.getElementById("tabState"),V=document.getElementById("tabEvents"),W=document.getElementById("tabAdmin"),J=document.getElementById("checkDelayRow"),X=document.getElementById("disableAfterRow");function K(e,t,n){return Math.min(n,Math.max(t,e))}function Q(e){const t=Math.max(0,Math.floor(e));return`${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`}function G(e){const t=p[e]||{};return{closeDelay:Number(null!=t.closeDelay?t.closeDelay:f.closeDelay),checkDelay:Number(null!=t.checkDelay?t.checkDelay:f.checkDelay),retryDelay:Number(null!=t.retryDelay?t.retryDelay:f.retryDelay),disableAfter:Number(null!=t.disableAfter?t.disableAfter:u)}}function Y(e){if("number"!=typeof e||Number.isNaN(e))return c[0];let t=c[0],n=Math.abs(e-t);for(const a of c){const r=Math.abs(e-a);r<n&&(n=r,t=a)}return t}function Z(){if(!R)return;const e=document.getElementById("systemToggleTrack"),t=document.getElementById("systemToggleThumb");e&&t&&(y?(e.className="relative h-5 sm:h-6 w-9 sm:w-12 rounded-full transition-colors bg-emerald-500/30",t.className="absolute top-0.5 sm:top-1 h-4 w-4 rounded-full transition-all left-4 sm:left-7 bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.6)]"):(e.className="relative h-5 sm:h-6 w-9 sm:w-12 rounded-full transition-colors bg-zinc-700",t.className="absolute top-0.5 sm:top-1 h-4 w-4 rounded-full transition-all left-1 bg-zinc-500"))}function ee(){return S&&!E&&!D&&!L}function te(){ee()?(q&&q.classList.remove("hidden"),R&&R.classList.remove("hidden")):(q&&q.classList.add("hidden"),R&&R.classList.add("hidden"),F.classList.add("hidden"),_=!1),W&&(k?W.classList.remove("hidden"):W.classList.add("hidden")),_e(k||"admin"!==w?w:"state");const e=k;J&&J.classList.toggle("hidden",!e),X&&X.classList.toggle("hidden",!e)}function ne(e){const t=((e&&e.app_metadata?e.app_metadata.role:"")||"").toLowerCase();E=t===m,D="restricted"===t,L=t===g,C=function(e){if(!e)return"";const t=(e.app_metadata?.role||"").toLowerCase(),n=e.user_metadata||{};return`${(n.first_name||"").trim()} ${(n.last_name||"").trim()}`.trim()||(t===g||t===m?"Guest":(e.email||"").trim())}(e)}async function ae(e){S=!1,k=!1;const t=e&&e.email?String(e.email).toLowerCase():"";if(t){try{const{data:e,error:n}=await a.from("garage_admins").select("email").eq("email",t).maybeSingle();!n&&e&&(S=!0)}catch{}try{const{data:e,error:n}=await a.from("garage_owners").select("email").eq("email",t).maybeSingle();!n&&e&&(k=!0)}catch{}}}function re(e){return e?new Date(e).toLocaleString("en-US",{month:"short",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—"}function oe(e){if(!e)return null;const t=new Date(e).getTime();return Number.isNaN(t)?null:t}function se(e,t){const n=String(t||"").toUpperCase();for(let t=0;t<b.length;t+=1){const a=b[t];if(!a||a.door!==e)continue;if(String(a.event_type||"").toUpperCase()===n)return a.created_at||a.timestamp||null}return null}function ie(e,t){if(!e.is_open||!e.last_open)return{phase:"closed",remaining:0,total:1,progress:1,dueAt:null};const n=G(e.door),a=oe(e.last_open);if(!a)return{phase:"unscheduled",remaining:0,total:1,progress:1,dueAt:null};const r=oe(e.last_close_attempt_at),o=r&&r>a?"retry":"initial",i="initial"===o?a:r,l="initial"===o?n.closeDelay:n.retryDelay,c=oe(e.next_action_at);let d=null;if(c&&c>=i-5e3)d=c;else{u=i+60*l*1e3,d=Math.ceil(u/s)*s}var u;const m=Math.max(1,(d-i)/1e3),g=K((d-t)/1e3,0,m);return{phase:o,remaining:g,total:m,progress:g/m,dueAt:d}}function le(e,t,n){if(!e||!t)return{remaining:0,total:1,progress:1};const a=K((e-n)/1e3,0,t),r=a/Math.max(1,t);return{remaining:a,total:Math.max(1,t),progress:r}}function ce(e,t,n){const r=function(e){const t=!0===e.is_open||"true"===e.is_open,n=Number(null!=e.close_attempts?e.close_attempts:0),a=(Number(null!=e.failed_attempts?e.failed_attempts:0),Number(null!=G(e.door).disableAfter?G(e.door).disableAfter:u)),r=t&&a>0&&n>=a;return!0===e.offline||"true"===e.offline?{offline:!0,reason:e.offline_reason||"retries"}:r?{offline:!0,reason:"retries"}:{offline:!1,reason:"ok"}}(t),o=r.offline,l=G(t.door),c=Number(null!=t.close_attempts?t.close_attempts:0),d=Number(null!=t.failed_attempts?t.failed_attempts:0),m=!0===t.is_open||"true"===t.is_open,g=!o&&m,systemPaused=!!(document.body&&document.body.classList&&document.body.classList.contains("system-paused")),y=String(t.next_action||"").toLowerCase(),f=t.next_action_at?new Date(t.next_action_at).getTime():null,p=g&&"close_check"===y&&f>n,h=e.querySelector(".door-schedule");if(h){const e="door-schedule mt-1 inline-flex max-w-full items-center justify-center gap-2 rounded-full px-2 py-0.5 text-center text-[9px] sm:text-[10px] uppercase tracking-widest break-words leading-tight",a=oe(t.next_action_at);o?(h.textContent="Offline",h.className=`${e} text-zinc-400 bg-zinc-700/35`):g?systemPaused?(h.textContent="Paused",h.className=`${e} text-amber-200 bg-amber-500/10`):a&&a>n?(h.textContent=`Close @ ${function(e){if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?"—":t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}(a)}`,h.className=`${e} text-blue-200 bg-blue-500/10`):a&&a<=n?(h.textContent="Check delay",h.className=`${e} text-red-200 bg-red-500/15`):(h.textContent="Awaiting schedule",h.className=`${e} text-zinc-400 bg-zinc-700/35`):(h.textContent="No Schedule",h.className=`${e} text-zinc-500 bg-zinc-700/35`)}const x=e.querySelector(".ring-progress"),b=e.querySelector(".ring-center"),v=e.querySelector(".ring-container");let w,_="#10b981",S=!1;if(o)w={phase:"offline",remaining:0,total:1,progress:1},_="#71717a";else if(systemPaused&&g)w={phase:"paused",remaining:0,total:1,progress:1},_="#f59e0b";else if(p){const e=oe(t.last_close_attempt_at);let a=60*l.checkDelay;if(e&&f&&f>e)a=Math.max(1,Math.round((f-e)/1e3));else if(f){const e=f-60*l.checkDelay*1e3;a=Math.max(1,Math.round((f-e)/1e3))}w=le(f,a,n),w.phase="verifying",S=!0,_="#ef4444"}else if(g){if(w=ie(t,n),"close_attempt"===y&&w.dueAt&&n>=w.dueAt){const e=w.dueAt+60*l.checkDelay*1e3;if(n<=e)w=le(e,60*l.checkDelay,n),w.phase="verifying",S=!0,_="#ef4444";else{w=le(e+60*l.retryDelay*1e3,60*l.retryDelay,n),w.phase="retry",_="#f59e0b"}}else _="retry"===w.phase?"#f59e0b":"#3b82f6";if("close_attempt"===y){const e=oe(t.last_close_attempt_at),a=e?e+60*l.checkDelay*1e3:null;a&&(!f||f<=n)&&n<=a+s&&(w=le(a,60*l.checkDelay,n),w.phase="verifying",S=!0,_="#ef4444")}}else w={phase:"closed",remaining:0,total:1,progress:1};const k=i-w.progress*i;if(x.style.stroke=_,x.style.strokeDashoffset=k,o?(v.classList.remove("animate-pulse-glow"),x.style.filter="drop-shadow(0 0 6px rgba(113, 113, 122, 0.35))"):S?(v.classList.add("animate-pulse-glow"),x.style.filter="drop-shadow(0 0 14px rgba(239, 68, 68, 0.55))"):systemPaused?(v.classList.remove("animate-pulse-glow"),x.style.filter="drop-shadow(0 0 10px rgba(245, 158, 11, 0.55))"):g?(v.classList.remove("animate-pulse-glow"),x.style.filter="drop-shadow(0 0 10px rgba(59, 130, 246, 0.55))"):(v.classList.remove("animate-pulse-glow"),x.style.filter="drop-shadow(0 0 8px rgba(16, 185, 129, 0.45))"),o)b.innerHTML='\n          <div class="mb-0.5 sm:mb-1 flex h-6 w-6 sm:h-8 sm:w-8 items-center justify-center rounded-full bg-zinc-500/15">\n            <svg class="h-4 w-4 sm:h-5 sm:w-5 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">\n              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>\n            </svg>\n          </div>\n          <span class="text-xs sm:text-sm uppercase tracking-widest text-zinc-400">Offline</span>\n        ';else if(g){if(systemPaused)b.innerHTML='\n          <div class="mb-0.5 sm:mb-1 flex h-6 w-6 sm:h-8 sm:w-8 items-center justify-center rounded-full bg-amber-500/15">\n            <svg class="h-4 w-4 sm:h-5 sm:w-5 text-amber-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">\n              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>\n            </svg>\n          </div>\n          <span class="text-xs sm:text-sm uppercase tracking-widest text-amber-300">Paused</span>\n        ';else{const e=S?"text-red-300":"retry"===w.phase?"text-amber-300":"text-blue-300";let n="until close";if("verifying"===w.phase)n="verifying";else if("retry"===w.phase){const e=c+1;n=e>1?`until retry x${e}`:"until retry"}const a=t.last_close_attempt_at&&t.last_open&&new Date(t.last_close_attempt_at).getTime()>new Date(t.last_open).getTime();b.innerHTML=`\n          <span class="font-mono text-xl sm:text-3xl font-light ${e}">${Q(w.remaining)}</span>\n          <span class="mt-0.5 sm:mt-1 text-[8px] sm:text-[10px] uppercase tracking-widest text-zinc-500">${n}</span>\n          ${a?'<span class="mt-0.5 sm:mt-1 text-[8px] sm:text-[10px] text-amber-400">Retry</span>':""}\n        `}}else b.innerHTML='\n          <div class="mb-0.5 sm:mb-1 flex h-6 w-6 sm:h-8 sm:w-8 items-center justify-center rounded-full bg-emerald-500/15">\n            <svg class="h-4 w-4 sm:h-5 sm:w-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">\n              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>\n            </svg>\n          </div>\n          <span class="text-xs sm:text-sm uppercase tracking-widest text-emerald-400">Closed</span>\n        ';const C=e.querySelector(".event-dot"),I=e.querySelector(".event-type"),B=e.querySelector(".event-time"),$=o?"OFFLINE":g?"OPENED":"CLOSED";I.textContent=$,B.textContent=re(o?t.offline_set_at:t.last_event_at),$.includes("OFFLINE")?C.className="event-dot h-2 w-2 rounded-full bg-zinc-400":$.includes("FAIL")||$.includes("ERROR")?C.className="event-dot h-2 w-2 rounded-full bg-amber-400":$.includes("CLOSED")?C.className="event-dot h-2 w-2 rounded-full bg-emerald-400":C.className="event-dot h-2 w-2 rounded-full bg-blue-400";const N=t.last_close||se(t.door,"CLOSED")||se(t.door,"CLOSE_SUCCEEDED"),O=e.querySelector(".duration-label"),A=e.querySelector(".duration-value");O.textContent=o?"Offline Reason":m?"Open For":"Closed For",o?A.textContent="retries"===r.reason?"Check Router":r.reason:m&&t.last_open?A.textContent=Q((n-new Date(t.last_open).getTime())/1e3):A.textContent=!m&&N?function(e){if(!e||e<0)return"—";const t=e/36e5;return t<1?`${Math.floor(e/6e4)}m`:t<24?`${Math.floor(t)}h ${Math.floor(e%36e5/6e4)}m`:`${Math.floor(t/24)}d ${Math.floor(t%24)}h`}(n-new Date(N).getTime()):"—";const T=e.querySelector(".next-action"),z=e.querySelector(".next-in"),M=e.querySelector(".attempts");if(M){const e=G(t.door),n=Number(e.retryDelay||0),a=Number(e.checkDelay||0);let r=t.offline_set_at||null;if(!r&&t.last_close_attempt_at&&d>0){const e=new Date(t.last_close_attempt_at).getTime();if(!Number.isNaN(e)){const t=Math.max(0,d-1)*(n+a);r=new Date(e-60*t*1e3).toISOString()}}M.textContent=o?`OFFLINE AT: ${re(r)}`:m?`OPENED AT: ${re(t.last_open)}`:`CLOSED AT: ${re(N)}`,M.className="attempts mt-2 text-[9px] sm:text-[10px] uppercase tracking-widest text-zinc-500"}if(o)T.textContent="Service",z.textContent="0:00";else if("verifying"===w.phase)T.textContent="Verifying close",z.textContent=`~${Q(w.remaining)}`;else if(g){if("retry"===w.phase)if(D||L)T.textContent="Until Retry";else{const e=c+1;T.textContent=e>1?`Until Retry x${e}`:"Until Retry"}else T.textContent="Until Close";z.textContent=`~${Q(w.remaining)}`}else T.textContent="Idle",z.textContent="0:00";const F=e.querySelector(".action-container"),P=`${g}-${p}-${E}-${L}-${y}-${o}`;if(F.dataset.actionKey!==P)if(F.dataset.actionKey=P,o)F.innerHTML='\n            <button disabled class="w-full rounded-lg sm:rounded-xl border border-zinc-800 bg-zinc-900/50 px-3 sm:px-4 py-2 sm:py-3 text-[10px] sm:text-xs uppercase tracking-widest text-zinc-500">\n              Offline\n            </button>\n          ';else if(g)if(E||L)F.innerHTML='\n              <button disabled class="w-full rounded-lg sm:rounded-xl border border-zinc-800 bg-zinc-900/50 px-3 sm:px-4 py-2 sm:py-3 text-[10px] sm:text-xs uppercase tracking-widest text-zinc-500">\n                View Only\n              </button>\n            ';else if(p){const e=S?"border-red-500/50 bg-red-500/10 text-red-200 animate-pulse":"border-emerald-500/35 bg-emerald-500/10 text-emerald-200";F.innerHTML=`\n              <button disabled class="w-full rounded-lg sm:rounded-xl border px-3 sm:px-4 py-2 sm:py-3 text-[10px] sm:text-xs uppercase tracking-widest transition-all ${e}">\n                Closing...\n              </button>\n            `}else F.innerHTML=`\n              <button class="close-btn w-full select-none rounded-lg sm:rounded-xl py-2 sm:py-3 text-[10px] sm:text-xs uppercase tracking-widest transition-all hover:brightness-110"\n                      style="border: 1px solid transparent; background: linear-gradient(rgba(16,185,129,0.14), rgba(16,185,129,0.14)) padding-box, linear-gradient(rgba(63,63,70,0.7), rgba(63,63,70,0.7)) border-box; color: rgba(167,243,208,1); touch-action: none;"\n                      data-door="${t.door}">\n                <div class="flex flex-col items-center">\n                  <div>Close Now</div>\n                  <div class="mt-0.5 sm:mt-1 text-[9px] sm:text-[10px] tracking-[0.22em] text-zinc-400">hold 1s</div>\n                </div>\n              </button>\n            `,function(e){let t=!1,n=0,r=0;const o=()=>{t=!1,cancelAnimationFrame(r),e.style.background="linear-gradient(rgba(16,185,129,0.14), rgba(16,185,129,0.14)) padding-box, linear-gradient(rgba(63,63,70,0.7), rgba(63,63,70,0.7)) border-box"},s=()=>{const t=K((performance.now()-n)/1e3,0,1),i=Math.round(360*t);if(e.style.background=`linear-gradient(rgba(16,185,129,0.14), rgba(16,185,129,0.14)) padding-box, conic-gradient(rgba(52,211,153,0.95) ${i}deg, rgba(63,63,70,0.55) 0deg) border-box`,t>=1)return o(),void async function(e,t){if(E||L)return void alert("This account is view-only.");try{const{data:n,error:r}=await a.functions.invoke("garage-event",{body:{door:e,event_type:"close"===t?"CLOSE_REQUESTED":"OPEN_REQUESTED",source:"ui",timestamp:(new Date).toISOString()}});if(r)return console.error("Failed to trigger door:",r),void alert(`Failed to ${t} ${e} door: ${r.message||"Unknown error"}`);n&&n.error&&(console.error("Failed to trigger door:",n.error),alert(`Failed to ${t} ${e} door: ${n.error}`))}catch(t){console.error("Error triggering door:",t),alert(`Error triggering ${e} door: ${t.message}`)}}(e.dataset.door,"close");r=requestAnimationFrame(s)};e.addEventListener("pointerdown",e=>{e.preventDefault(),t=!0,n=performance.now(),r=requestAnimationFrame(s)}),e.addEventListener("pointerup",o),e.addEventListener("pointercancel",o),e.addEventListener("pointerleave",o),e.addEventListener("contextmenu",e=>e.preventDefault())}(F.querySelector(".close-btn"));else F.innerHTML=""}function de(){const e=9e5,t={},n={};b.forEach(e=>{if("CLOSE_REQUESTED"===(e.event_type||"").toUpperCase()&&e.door){const a=new Date(e.created_at).getTime();if(!Number.isNaN(a)){"system"===(e.payload&&e.payload.source||"").toLowerCase()?(n[e.door]||(n[e.door]=[]),n[e.door].push(a)):(t[e.door]||(t[e.door]=[]),t[e.door].push(a))}}}),["Left","Middle","Right"].forEach(a=>{const r=document.querySelectorAll(`.events-column[data-door="${a}"]`);if(!r.length)return;if(v&&(!b||0===b.length))return void r.forEach(e=>{e.innerHTML='<div class="px-3 py-4 text-center text-xs text-zinc-500">Loading events…</div>'});const o=b.filter(e=>{const t=(e.event_type||"").toUpperCase();return e.door===a&&("OPEN"===t||"CLOSED"===t||"CLOSE_FAILED"===t||"DISABLED"===t||"OFFLINE"===t)}),s={};o.forEach(e=>{const t=new Date(e.created_at).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});s[t]||(s[t]=[]),s[t].push(e)});let i="";Object.entries(s).forEach(([r,o])=>{i+=`<div class="sticky top-0 z-10 bg-zinc-900/95 backdrop-blur-sm px-3 py-2 text-[10px] uppercase tracking-widest text-zinc-400 border-b border-zinc-800/50">${r}</div>`,o.forEach(r=>{const o=(r.event_type||"").toUpperCase(),s="OPEN"===o,l="CLOSE_FAILED"===o,c="DISABLED"===o||"OFFLINE"===o;let d=!1;if("CLOSED"===o){const o=new Date(r.created_at).getTime(),s=t[a]||[],i=n[a]||[],l=s.some(t=>t<=o&&o-t<=e),c=i.some(t=>t<=o&&o-t<=e);d=!l&&c}const u=s?"bg-blue-400":l?"bg-red-400":c?"bg-zinc-400":d?"bg-pink-400":"bg-emerald-400",m=s?"Opened":l?"Close Failed":c?"Disabled":d?"System Closed":"Closed",g=new Date(r.created_at).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"});i+=`\n              <div class="flex items-center justify-between px-3 py-2 border-b border-zinc-800/30">\n                <div class="flex items-center gap-2">\n                  <span class="h-2 w-2 rounded-full ${u}"></span>\n                  <span class="text-sm text-zinc-300">${m}</span>\n                </div>\n                <span class="text-xs text-zinc-500">${g}</span>\n              </div>\n            `})}),r.forEach(e=>{e.innerHTML=i||'<div class="px-3 py-4 text-center text-xs text-zinc-600">No events</div>'})})}function ue(e,t){if(null==t)return"—";const n=Number(t);return Number.isNaN(n)&&"enabled"!==e?String(t):"enabled"===e?t?"On":"Off":"check_delay_min"===e?xe(n):"disable_after_attempts"===e?`${Math.round(n)} tries`:`${n} min`}function me(){if(!H)return;if(!k)return void(H.innerHTML="");if(T&&(!A||0===A.length))return void(H.innerHTML='<div class="px-3 py-4 text-center text-xs text-zinc-500">Loading history…</div>');const e={};(A||[]).forEach(t=>{const n=t.created_at||t.createdAt,a=new Date(n);if(Number.isNaN(a.getTime()))return;const r=a.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});e[r]||(e[r]=[]),e[r].push(t)});let t="";Object.entries(e).forEach(([e,n])=>{t+=`<div class="sticky top-0 z-10 bg-zinc-900/95 backdrop-blur-sm px-3 py-2 text-[10px] uppercase tracking-widest text-zinc-400 border-b border-zinc-800/50">${e}</div>`,n.forEach(e=>{const n=e.changes||{};let a=n;if("string"==typeof n)try{a=JSON.parse(n)}catch{a={}}const r=Object.entries(a||{}).map(([e,t])=>{const n=function(e){switch(e){case"close_delay_min":return"Close delay";case"check_delay_min":return"Check delay";case"retry_delay_min":return"Retry delay";case"disable_after_attempts":return"Disable after";case"enabled":return"System";default:return e}}(e),a=Array.isArray(t)?t[0]:null,r=Array.isArray(t)?t[1]:t;return`${n} ${ue(e,a)} → ${ue(e,r)}`}).join(", "),o=e.changed_by_name||e.changed_by_email||"Unknown",s=e.created_at||e.createdAt,i=new Date(s).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}),l=e.door?e.door:"System";t+=`\n            <div class="flex items-start justify-between gap-3 px-3 py-2 border-b border-zinc-800/30">\n              <div class="min-w-0">\n                <div class="text-[10px] uppercase tracking-widest text-zinc-500">${l}</div>\n                <div class="text-sm text-zinc-200 break-words">${r||"Settings updated"}</div>\n                <div class="text-[10px] uppercase tracking-widest text-zinc-500">by ${o}</div>\n              </div>\n              <div class="text-xs text-zinc-500">${i}</div>\n            </div>\n          `})}),H.innerHTML=t||'<div class="px-3 py-4 text-center text-xs text-zinc-600">No timer history</div>'}function ge(){const e=Date.now(),t={};(x||[]).forEach(e=>{e&&e.door&&(t[e.door]=e)});z.querySelectorAll("[data-door]").length!==d.length&&(z.innerHTML="",d.forEach(e=>{const n=function(e){const t=P.content.cloneNode(!0).querySelector(".door-card");return t.dataset.door=e.door,t.querySelector(".door-name").textContent=e.door,t}(t[e]||{door:e});z.appendChild(n)})),d.forEach(n=>{const a=t[n]||{door:n},r=z.querySelector(`[data-door="${n}"]`);r&&ce(r,a,e)});const n=C?`${C} • `:"";document.getElementById("statusText").textContent=`${n}Live data • ${y?"System enabled":"System paused"}`;const r=document.getElementById("systemStatusBanner");r&&r.classList.toggle("hidden",y);document.body.classList.toggle("system-paused",!y)}let ye=!1,fe=!1;function pe(e,t){if(!t)return!1;if(function(e){return String(e&&e.message||e||"").toLowerCase().includes("abort")}(t))return console.warn(`Request aborted for ${e}:`,t),!0;const n=t.message||String(t);return console.error(`Failed to load ${e}:`,t),n.toLowerCase().includes("permission denied")?(je(),ut(),I&&(a.removeChannel(I),I=null),!0):(document.getElementById("statusText").textContent=`Data error • ${e}: ${n}`,alert(`Failed to load ${e}: ${n}`),!0)}async function he(){if(ye)fe=!0;else{ye=!0;try{const{data:e}=await a.auth.getSession();if(!e||!e.session)return je(),ut(),void(I&&(a.removeChannel(I),I=null));const{data:t,error:n}=await a.from("garage_state").select("*").order("door");pe("door state",n)||(x=function(e){const t={};return(e||[]).forEach(e=>{e&&e.door&&(t[e.door]=e)}),d.map(e=>Object.assign({door:e},t[e]||{},{_hasData:Boolean(t[e])}))}(t)),v=!0,b.length||de();const{data:r,error:o}=await async function(){let e=[],t=0;for(;;){const{data:n,error:r}=await a.from("garage_events").select("*").order("created_at",{ascending:!1}).range(t,t+l-1);if(r)return{data:null,error:r};if(!n||0===n.length)break;if(e=e.concat(n),n.length<l)break;t+=l}return{data:e,error:null}}();if(pe("events",o)||(b=r||[]),v=!1,de(),k){T=!0,A.length||me();const{data:e,error:t}=await async function(){const{data:e,error:t}=await a.from("garage_timer_history").select("*").order("created_at",{ascending:!1}).limit(500);return{data:e,error:t}}();pe("timer history",t)||(A=e||[]),T=!1,me()}else A.length&&(A=[],T=!1,me());const{data:s,error:i}=await a.from("garage_settings").select("*").single();pe("settings",i)||s&&(f.closeDelay=s.close_delay_min||10,f.checkDelay=s.check_delay_min||1,f.retryDelay=s.retry_delay_min||5,"boolean"==typeof s.enabled&&(y=s.enabled,Z()));const{data:c,error:m}=await a.from("garage_door_settings").select("*").order("door");pe("door settings",m)?d.forEach(e=>{p[e]={closeDelay:f.closeDelay,checkDelay:f.checkDelay,retryDelay:f.retryDelay,disableAfter:u}}):d.forEach(e=>{const t=(c||[]).find(t=>t.door===e)||{};p[e]={closeDelay:Number(null!=t.close_delay_min?t.close_delay_min:f.closeDelay),checkDelay:Number(null!=t.check_delay_min?t.check_delay_min:f.checkDelay),retryDelay:Number(null!=t.retry_delay_min?t.retry_delay_min:f.retryDelay),disableAfter:Number(null!=t.disable_after_attempts?t.disable_after_attempts:u)}}),be(),ge()}finally{ye=!1,fe&&(fe=!1,he())}}}function xe(e){const t=Math.round(60*e),n=Math.floor(t/60),a=t%60;return 0===n?`${a}s`:0===a?`${n}m`:`${n}m ${a}s`}function be(){const e=G(h);e.closeDelay=Y(e.closeDelay),p[h]=e;const t=function(e){const t=Y(e);return c.indexOf(t)}(e.closeDelay);document.getElementById("closeDelayValue").textContent=e.closeDelay,document.getElementById("closeDelayBar").style.width=t/(c.length-1)*100+"%",document.getElementById("closeDelaySlider").value=t,document.getElementById("checkDelayValue").textContent=xe(e.checkDelay),document.getElementById("checkDelayBar").style.width=(e.checkDelay-.5)/3.5*100+"%",document.getElementById("checkDelaySlider").value=e.checkDelay,document.getElementById("retryDelayValue").textContent=e.retryDelay,document.getElementById("retryDelayBar").style.width=(e.retryDelay-3)/7*100+"%",document.getElementById("retryDelaySlider").value=e.retryDelay;const n=K(Math.round(e.disableAfter),5,18);e.disableAfter=n,document.getElementById("disableAfterValue").textContent=n,document.getElementById("disableAfterBar").style.width=(n-5)/13*100+"%",document.getElementById("disableAfterSlider").value=n,document.getElementById("settingsDoorLabel").textContent=`Door settings: ${h}`,document.querySelectorAll(".settings-door-tab").forEach(e=>{const t=e.dataset.door===h;e.className=t?"settings-door-tab flex-1 rounded-lg px-3 py-2 text-[10px] uppercase tracking-widest transition-colors bg-zinc-800/70 text-zinc-100":"settings-door-tab flex-1 rounded-lg px-3 py-2 text-[10px] uppercase tracking-widest transition-colors text-zinc-500"})}q.addEventListener("click",()=>{ee()&&(_=!_,F.classList.toggle("hidden",!_))}),document.getElementById("saveSettingsBtn").addEventListener("click",async function(){if(!ee())return void alert("Settings access is restricted.");const e=(new Date).toISOString(),t=d.map(t=>{const n=G(t);return{door:t,close_delay_min:n.closeDelay,check_delay_min:n.checkDelay,retry_delay_min:n.retryDelay,disable_after_attempts:n.disableAfter,updated_at:e}}),{error:n}=await a.from("garage_door_settings").upsert(t,{onConflict:"door"});if(n)return console.error("Failed to save door settings:",n),void alert(`Failed to save settings: ${n.message}`);const{error:r}=await a.functions.invoke("garage-reschedule",{body:{doors:d}});r&&console.warn("Failed to reschedule open doors:",r),F.classList.add("hidden"),_=!1,he()}),document.querySelectorAll(".settings-door-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.door;t&&(h=t,be())})}),document.getElementById("closeDelaySlider").addEventListener("input",e=>{const t=K(parseInt(e.target.value,10),0,c.length-1),n=G(h);n.closeDelay=c[t],p[h]=n,document.getElementById("closeDelayValue").textContent=n.closeDelay,document.getElementById("closeDelayBar").style.width=t/(c.length-1)*100+"%"}),document.getElementById("checkDelaySlider").addEventListener("input",e=>{const t=G(h);t.checkDelay=parseFloat(e.target.value),p[h]=t,document.getElementById("checkDelayValue").textContent=xe(t.checkDelay),document.getElementById("checkDelayBar").style.width=(t.checkDelay-.5)/3.5*100+"%"}),document.getElementById("retryDelaySlider").addEventListener("input",e=>{const t=G(h);t.retryDelay=parseInt(e.target.value),p[h]=t,document.getElementById("retryDelayValue").textContent=t.retryDelay,document.getElementById("retryDelayBar").style.width=(t.retryDelay-3)/7*100+"%"}),document.getElementById("disableAfterSlider").addEventListener("input",e=>{const t=G(h);t.disableAfter=K(parseInt(e.target.value,10),5,18),p[h]=t,document.getElementById("disableAfterValue").textContent=t.disableAfter,document.getElementById("disableAfterBar").style.width=(t.disableAfter-5)/13*100+"%"});const ve="flex items-center gap-1.5 sm:gap-2 rounded-lg p-2 sm:px-4 sm:py-2 transition-colors bg-zinc-800/50 text-zinc-100",we="flex items-center gap-1.5 sm:gap-2 rounded-lg p-2 sm:px-4 sm:py-2 transition-colors text-zinc-500 hover:text-zinc-300";function _e(e){if(w=e,j&&(j.className="state"===e?ve:we),V&&(V.className="events"===e?ve:we),W){const t="admin"===e?ve:we;W.className=k?t:`${t} hidden`}z&&z.classList.toggle("hidden","state"!==e),M&&M.classList.toggle("hidden","events"!==e),U&&U.classList.toggle("hidden","admin"!==e)}function Ee(){I||(I=a.channel("garage_changes").on("postgres_changes",{event:"*",schema:"public",table:"garage_state"},()=>he()).on("postgres_changes",{event:"INSERT",schema:"public",table:"garage_events"},()=>he()).subscribe())}j&&j.addEventListener("click",()=>_e("state")),V&&V.addEventListener("click",()=>_e("events")),W&&W.addEventListener("click",()=>{k&&_e("admin")}),document.getElementById("refreshBtn").addEventListener("click",he),document.querySelectorAll(".events-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.door;document.querySelectorAll(".events-tab").forEach(e=>{e.dataset.door===t?e.className="events-tab flex-1 rounded-lg py-2 text-[10px] uppercase tracking-widest transition-colors bg-zinc-800/70 text-zinc-100":e.className="events-tab flex-1 rounded-lg py-2 text-[10px] uppercase tracking-widest transition-colors text-zinc-500"}),document.querySelectorAll(".events-panel").forEach(e=>{e.dataset.door===t?e.classList.remove("hidden"):e.classList.add("hidden")})})}),document.getElementById("systemToggle").addEventListener("click",async()=>{if(!ee())return void alert("Settings access is restricted.");const e=!y;y=e,Z(),ge();const{error:t}=await a.from("garage_settings").update({enabled:y,updated_at:(new Date).toISOString()}).eq("id","global");if(t)return console.error("Failed to update system toggle:",t),y=!e,Z(),ge(),void alert(`Failed to update system toggle: ${t.message}`);he()});const De=document.getElementById("loginPage"),Le=document.getElementById("appContainer"),Se=document.getElementById("loginForm"),ke=document.getElementById("loginBtn"),Ce=document.getElementById("loginEmail"),Ie=document.getElementById("loginPassword"),Be=document.getElementById("loginError"),$e=document.getElementById("resetNotice"),Ne=document.getElementById("forgotBtn"),Oe=document.getElementById("resetRequestForm"),Ae=document.getElementById("resetEmail"),Te=document.getElementById("resetRequestError"),ze=document.getElementById("resetRequestBtn"),Me=document.getElementById("resetBackBtn"),Fe=document.getElementById("passwordResetForm"),Pe=document.getElementById("newPassword"),qe=document.getElementById("confirmPassword"),Re=document.getElementById("passwordResetError"),Ue=document.getElementById("passwordResetBtn"),He=document.getElementById("signOutBtn");function je(){De.classList.remove("hidden"),Le.classList.add("hidden")}function Ve(){De.classList.add("hidden"),Le.classList.remove("hidden")}function We(e){Be.textContent=e,Be.classList.remove("hidden")}function Je(){Be.classList.add("hidden")}function Xe(e){$e.textContent=e,$e.classList.remove("hidden")}function Ke(){$e.classList.add("hidden")}function Qe(e){Te.textContent=e,Te.classList.remove("hidden")}function Ge(){Te.classList.add("hidden")}function Ye(e){Re.textContent=e,Re.classList.remove("hidden")}function Ze(){Se.classList.remove("hidden"),Oe.classList.add("hidden"),Fe.classList.add("hidden")}function et(){Se.classList.add("hidden"),Oe.classList.add("hidden"),Fe.classList.remove("hidden")}async function tt(e){if(!e)return;B=crypto.randomUUID(),$=Date.now();const t=(new Date).toISOString();try{await a.from("garage_user_sessions").insert({id:B,user_id:e.id,email:e.email,session_start:t,last_seen_at:t})}catch(e){console.warn("Failed to start session log:",e)}N&&clearInterval(N),N=setInterval(()=>{!async function(){if(!B)return;try{await a.from("garage_user_sessions").update({last_seen_at:(new Date).toISOString()}).eq("id",B)}catch{}}()},6e4)}function nt(){const e=navigator.userAgent||"",t=/Mobi|Android|iPhone|iPad|iPod/i.test(e);let n="Unknown",a="";-1!==e.indexOf("Edg/")?n="Edge":-1!==e.indexOf("Chrome/")?n="Chrome":-1!==e.indexOf("Safari/")&&-1===e.indexOf("Chrome/")?n="Safari":-1!==e.indexOf("Firefox/")&&(n="Firefox");let r="Unknown",o="";/Windows NT/i.test(e)?r="Windows":/Mac OS X/i.test(e)&&!/iPhone|iPad|iPod/i.test(e)?r="macOS":/Android/i.test(e)?r="Android":/iPhone|iPad|iPod/i.test(e)?r="iOS":/Linux/i.test(e)&&(r="Linux");const s=e.match(/(Edg|Chrome|Firefox|Version)\/([0-9.]+)/);s&&(a=s[2]||"");const i=e.match(/Mac OS X ([0-9_]+)/);i&&(o=i[1].replace(/_/g,"."));const l=e.match(/OS ([0-9_]+) like Mac OS X/);l&&(o=l[1].replace(/_/g,"."));const c=e.match(/Android ([0-9.]+)/);c&&(o=c[1]);const d=e.match(/Windows NT ([0-9.]+)/);d&&(o=d[1]);let u="";e.match(/iPhone\sOS\s[0-9_]+/)&&(u="iPhone");e.match(/iPad\sOS\s[0-9_]+/)&&(u="iPad");const m=e.match(/Android [0-9.]+;\s*([^;)]*)/);m&&(u=m[1].trim());const g=navigator.connection||navigator.mozConnection||navigator.webkitConnection,y=window.innerWidth||document.documentElement&&document.documentElement.clientWidth||null,f=window.innerHeight||document.documentElement&&document.documentElement.clientHeight||null;return{device_type:t?"mobile":"desktop",browser:n,browser_version:a,os:r,os_version:o,device_model:u,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,timezone_offset_min:(new Date).getTimezoneOffset(),language:navigator.language||"",locale:navigator.language||"",screen:screen&&screen.width&&screen.height?`${screen.width}x${screen.height}`:"",screen_width:screen&&screen.width?screen.width:null,screen_height:screen&&screen.height?screen.height:null,viewport_width:y,viewport_height:f,color_depth:screen&&screen.colorDepth?screen.colorDepth:null,device_pixel_ratio:window.devicePixelRatio||null,hardware_concurrency:navigator.hardwareConcurrency||null,device_memory_gb:navigator.deviceMemory||null,max_touch_points:navigator.maxTouchPoints||null,connection_type:g&&g.effectiveType?g.effectiveType:null,connection_downlink:g&&g.downlink?g.downlink:null,connection_rtt:g&&g.rtt?g.rtt:null,page:location.pathname,referrer:document.referrer||""}}function at(){try{const e=localStorage.getItem(r);if(e)return e;const t=crypto.randomUUID();return localStorage.setItem(r,t),t}catch{return null}}async function rt(e="login",r=null){try{const{data:o}=await a.auth.getSession(),s=o?.session?.access_token;if(!s)return;const i=nt();await fetch(`${t}/functions/v1/garage-login-log`,{method:"POST",headers:{apikey:n,Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify(Object.assign({event_type:e,details:r},i))})}catch(e){console.warn("Failed to log login event:",e)}}function ot(){O||(O=setInterval(()=>{"visible"===document.visibilityState&&rt("view_active")},6e4))}function st(){O&&(clearInterval(O),O=null)}async function it(){if(!B)return;const e=(new Date).toISOString(),t=$?Math.round((Date.now()-$)/1e3):null;try{await a.from("garage_user_sessions").update({session_end:e,duration_sec:t,last_seen_at:e}).eq("id",B)}catch{}N&&(clearInterval(N),N=null),B=null,$=null}Se.addEventListener("submit",e=>{e.preventDefault(),async function(){const e=Ce.value.trim(),r="guest"===e.toLowerCase()?GUEST_EMAIL:e,o=Ie.value;if(!r||!o)return void We("Please enter email and password");Ke(),Je(),ke.textContent="Signing in...",ke.disabled=!0;const s=nt(),i=at();let l=null,c=null;try{const e=await fetch(`${t}/functions/v1/garage-login`,{method:"POST",headers:{apikey:n,"Content-Type":"application/json"},body:JSON.stringify(Object.assign({email:r,password:o,anon_id:i},s))}),a=await e.text();try{l=JSON.parse(a)}catch{l=null}e.ok||(c={message:l&&l.error||`HTTP ${e.status}`})}catch(e){c=e||{message:"Failed to send a request to the Edge Function"}}if(ke.textContent="Sign In",ke.disabled=!1,c||!l||!l.ok||!l.session){const e=c&&c.message||l&&l.error||"Login failed",t=String(e).toLowerCase().includes("too many")?"Too many attempts. Try again later.":String(e).toLowerCase().includes("invalid")?"Incorrect email or password.":String(e);return rt("login_failed",{message:e||"unknown"}),void We(t)}const d=l.session||null;d&&d.access_token&&d.refresh_token&&await a.auth.setSession({access_token:d.access_token,refresh_token:d.refresh_token});const{data:u}=await a.auth.getSession(),m=u&&u.session?u.session.user:null;ne(m),await ae(m),te(),Ve(),he(),Ee(),dt(),tt(m),rt("login"),ot()}()}),Oe.addEventListener("submit",async function(e){e.preventDefault();const t=Ae.value.trim().toLowerCase();if(!t)return void Qe("Please enter your email.");Ge(),Ke(),ze.textContent="Sending...",ze.disabled=!0;const n=location.pathname.endsWith("/")?location.pathname:location.pathname.replace(/[^/]+$/,""),r=`${location.origin}${n}reset.html`,{error:o}=await a.auth.resetPasswordForEmail(t,{redirectTo:r});ze.textContent="Send reset link",ze.disabled=!1,o?Qe(o.message):Xe("If that email exists, a reset link has been sent.")}),Fe.addEventListener("submit",async function(e){e.preventDefault();const t=Pe.value,n=qe.value;if(!t||!n)return void Ye("Please enter and confirm your new password.");if(t!==n)return void Ye("Passwords do not match.");Re.classList.add("hidden"),Ke(),Ue.textContent="Updating...",Ue.disabled=!0;const{error:r}=await a.auth.updateUser({password:t});Ue.textContent="Update password",Ue.disabled=!1,r?Ye(r.message):(Pe.value="",qe.value="",history.replaceState(null,"",location.pathname),Ze(),Xe("Password updated. Please sign in."))}),Ne.addEventListener("click",()=>{Je(),Ke(),Se.classList.add("hidden"),Oe.classList.remove("hidden"),Fe.classList.add("hidden")}),Me.addEventListener("click",()=>{Ge(),Ze()}),Ce.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),Ie.focus())}),He.addEventListener("click",async function(){rt("logout"),await it(),await a.auth.signOut(),je(),ut(),st(),I&&(a.removeChannel(I),I=null),S=!1,k=!1,A=[],T=!1,W&&W.classList.add("hidden"),_e("state"),x=[],b=[],z.innerHTML="",document.querySelectorAll(".events-column").forEach(e=>e.innerHTML=""),H&&(H.innerHTML="")}),a.auth.onAuthStateChange(e=>{"PASSWORD_RECOVERY"===e&&(je(),et())}),window.addEventListener("pagehide",()=>{it()}),window.addEventListener("beforeunload",()=>{rt("unload"),it()}),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState?(rt("view_visible"),ot()):(rt("view_hidden"),st())});const lt=5e3;let ct=null;function dt(){ct||(ct=setInterval(he,lt))}function ut(){ct&&(clearInterval(ct),ct=null)}setInterval(ge,250),function(){const e=window.location.hash.replace(/^#/,"");if(!e)return!1;const t=new URLSearchParams(e);return"recovery"===t.get("type")||Boolean(t.get("access_token"))}()&&(je(),et()),async function(){if(!o){o=!0;try{const e=nt(),a=at();await fetch(`${t}/functions/v1/garage-page-view`,{method:"POST",headers:{apikey:n,"Content-Type":"application/json"},body:JSON.stringify({anon_id:a,path:location.pathname,referrer:document.referrer||"",title:document.title||"",screen:e.screen,viewport:`${window.innerWidth||0}x${window.innerHeight||0}`,device_type:e.device_type,browser:e.browser,os:e.os,timezone:e.timezone,locale:e.locale})})}catch(e){console.warn("Failed to log page view:",e)}}}(),async function(){const{data:{session:e}}=await a.auth.getSession();if(e){const t=e.user;ne(t),await ae(t),te(),Ve(),he(),Ee(),dt(),tt(t),rt("login"),ot()}else je(),Ze()}();</script></body></html>